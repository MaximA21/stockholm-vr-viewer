<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Points VR - Meta Quest 3</title>
    <script type="importmap">
        {
            "imports": {
                "three": "./node_modules/three/build/three.module.js",
                "three/addons/": "./node_modules/three/examples/jsm/"
            }
        }
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #001122;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
            max-width: 350px;
        }

        #vr-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 15px 30px;
            background: #44aa44;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            z-index: 100;
            display: none;
        }

        #vr-button:hover {
            background: #66cc66;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
        }
    </style>
</head>
<body>
<div id="info">
    <h2>ðŸŽ¯ Input Points VR</h2>
    <p id="status">Loading...</p>
    <p>Point cloud rendering for VR</p>
</div>

<div id="loading">Loading Point Cloud...<br>ðŸŽ¯âœ¨</div>
<button id="vr-button">Enter VR Mode</button>

<script type="module">
    import * as THREE from 'three';
    import {PLYLoader} from 'three/addons/loaders/PLYLoader.js';
    import {VRButton} from 'three/addons/webxr/VRButton.js';

    let scene, camera, renderer, pointCloud;
    let vrSupported = false;

    function updateStatus(message) {
        document.getElementById('status').textContent = message;
        console.log('Status:', message);
    }

    async function init() {
        try {
            updateStatus('Initializing VR point cloud scene...');

            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x001122);

            // Create camera for VR
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 0); // VR height

            // Create renderer with WebXR support
            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.xr.setFramebufferScaleFactor(1.5);
            document.body.appendChild(renderer.domElement);

            // Add VR button using Three.js built-in
            document.body.appendChild(VRButton.createButton(renderer));

            updateStatus('Setting up lighting for points...');

            // Ambient lighting for point clouds
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambientLight);

            // Ground reference
            const groundGeometry = new THREE.PlaneGeometry(20, 20);
            const groundMaterial = new THREE.MeshBasicMaterial({
                color: 0x222222,
                transparent: true,
                opacity: 0.3
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -1;
            scene.add(ground);

            updateStatus('Loading point cloud PLY...');
            await loadPointCloudPLY();

            updateStatus('Starting VR renderer...');

            // Start animation loop
            renderer.setAnimationLoop(animate);

            document.getElementById('loading').style.display = 'none';
            updateStatus('âœ… Point cloud loaded! Use VR button to enter VR');

            // Check VR support
            checkVRSupport();

        } catch (error) {
            console.error('Init Error:', error);
            updateStatus('âŒ Error: ' + error.message);
        }
    }

    async function loadPointCloudPLY() {
        return new Promise((resolve, reject) => {
            const loader = new PLYLoader();

            loader.load(
                './data/ai-room.ply',
                (geometry) => {
                    try {
                        console.log('Point cloud PLY loaded:', geometry);
                        updateStatus('Processing point cloud...');

                        // Center the geometry
                        geometry.computeBoundingBox();
                        const center = new THREE.Vector3();
                        geometry.boundingBox.getCenter(center);
                        geometry.translate(-center.x, -center.y, -center.z);

                        // Create points material - PERFECT for your PLY!
                        const pointsMaterial = new THREE.PointsMaterial({
                            size: 0.02,  // Point size for VR visibility
                            sizeAttenuation: true,  // Points get smaller with distance
                            transparent: true,
                            opacity: 0.8
                        });

                        // Enable vertex colors if PLY has them
                        if (geometry.attributes.color) {
                            pointsMaterial.vertexColors = true;
                            updateStatus('Using vertex colors for points...');
                        } else {
                            pointsMaterial.color.setHex(0xaaaaaa);
                            updateStatus('Using default color for points...');
                        }

                        // Create point cloud
                        pointCloud = new THREE.Points(geometry, pointsMaterial);

                        // Scale appropriately for VR
                        const box = new THREE.Box3().setFromObject(pointCloud);
                        const size = box.getSize(new THREE.Vector3());
                        const maxDimension = Math.max(size.x, size.y, size.z);
                        const targetSize = 20; // 2 meters in VR
                        const scale = targetSize / maxDimension;

                        pointCloud.scale.setScalar(scale);
                        pointCloud.position.y = 0; // Place on ground level

                        // --- NEW: Put everything in a 'world group' so we can set the spawn point ---
                        const worldGroup = new THREE.Group();
                        worldGroup.add(pointCloud);

// This moves the entire scene so the "spawn point" changes
// Example: Start 2m back and 1.6m above ground
                        worldGroup.position.set(-5, 1.5, -5);
                        worldGroup.rotation.x = Math.PI; // Math.PI = 180 degrees

                        scene.add(worldGroup);
// --- END NEW ---

                        //scene.add(pointCloud);

                        console.log(`Point cloud added. Points: ${geometry.attributes.position.count}, Scale: ${scale.toFixed(3)}`);
                        resolve();

                    } catch (error) {
                        reject(error);
                    }
                },
                (progress) => {
                    if (progress.total > 0) {
                        const percent = Math.round((progress.loaded / progress.total) * 100);
                        updateStatus(`Loading points... ${percent}%`);
                    }
                },
                (error) => {
                    console.error('PLY loading error:', error);
                    reject(error);
                }
            );
        });
    }

    async function checkVRSupport() {
        if (navigator.xr) {
            try {
                vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
                if (vrSupported) {
                    updateStatus('âœ… VR Ready! Point cloud optimized for VR');
                } else {
                    updateStatus('âŒ VR not supported on this device');
                }
            } catch (error) {
                updateStatus('âš ï¸ VR check failed: ' + error.message);
            }
        } else {
            updateStatus('âŒ WebXR not available');
        }
    }

    function animate() {
        // Add gentle rotation to the point cloud
        if (pointCloud) {
            const time = Date.now() * 0.001;
            pointCloud.rotation.y = Math.sin(time * 0.2) * 0.1;
        }

        renderer.render(scene, camera);
    }

    // Handle window resize
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Initialize everything
    init();
</script>
</body>
</html>