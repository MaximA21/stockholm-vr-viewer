<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Bear PLY VR - Meta Quest 3</title>
    <script type="importmap">
    {
        "imports": {
            "three": "./node_modules/three/build/three.module.js",
            "three/addons/": "./node_modules/three/examples/jsm/"
        }
    }
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #001122;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
            max-width: 350px;
        }
        
        #vr-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 15px 30px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            z-index: 100;
            display: none;
        }
        
        #vr-button:hover {
            background: #ff6666;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="info">
        <h2>üéÑ Christmas Bear PLY VR</h2>
        <p id="status">Loading...</p>
        <p>Loading original PLY mesh for VR</p>
    </div>
    
    <div id="loading">
        Loading Christmas Bear PLY...<br>
        üêªüéÑ
    </div>
    
    <button id="vr-button">Enter VR Mode</button>

    <script type="module">
        import * as THREE from 'three';
        import { PLYLoader } from 'three/addons/loaders/PLYLoader.js';
        import { VRButton } from 'three/addons/webxr/VRButton.js';

        let scene, camera, renderer, bear;
        let vrSupported = false;
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('Status:', message);
        }
        
        async function init() {
            try {
                updateStatus('Initializing Three.js VR scene...');
                
                // Create scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x001122);
                scene.fog = new THREE.Fog(0x001122, 1, 50);
                
                // Create camera for VR (will be handled by WebXR)
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 1.6, 3); // VR height
                
                // Create renderer with WebXR support
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                renderer.xr.enabled = true;
                document.body.appendChild(renderer.domElement);
                
                // Add VR button using Three.js built-in
                document.body.appendChild(VRButton.createButton(renderer));
                
                updateStatus('Setting up lighting...');
                
                // Lighting optimized for VR
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                directionalLight.shadow.camera.near = 0.1;
                directionalLight.shadow.camera.far = 50;
                directionalLight.shadow.camera.left = -10;
                directionalLight.shadow.camera.right = 10;
                directionalLight.shadow.camera.top = 10;
                directionalLight.shadow.camera.bottom = -10;
                scene.add(directionalLight);

                // Add some Christmas atmosphere
                const pointLight1 = new THREE.PointLight(0xff4444, 0.8, 5);
                pointLight1.position.set(-2, 2, 2);
                scene.add(pointLight1);

                const pointLight2 = new THREE.PointLight(0x44ff44, 0.8, 5);
                pointLight2.position.set(2, 2, 2);
                scene.add(pointLight2);

                // Ground plane
                const groundGeometry = new THREE.PlaneGeometry(10, 10);
                const groundMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x444444,
                    transparent: true,
                    opacity: 0.6
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.position.y = -0.1;
                ground.receiveShadow = true;
                scene.add(ground);
                
                updateStatus('Loading Christmas Bear PLY...');
                await loadBearPLY();
                
                updateStatus('Starting VR renderer...');
                
                // Start animation loop
                renderer.setAnimationLoop(animate);
                
                document.getElementById('loading').style.display = 'none';
                updateStatus('‚úÖ Bear loaded! Use VR button to enter VR');
                
                // Check VR support
                checkVRSupport();
                
            } catch (error) {
                console.error('Init Error:', error);
                updateStatus('‚ùå Error: ' + error.message);
            }
        }
        
        async function loadBearPLY() {
            return new Promise((resolve, reject) => {
                const loader = new PLYLoader();
                
                loader.load(
                    './data/Christmas Bear.ply',
                    (geometry) => {
                        try {
                            console.log('PLY loaded:', geometry);
                            updateStatus('Processing bear geometry...');
                            
                            // Center the geometry
                            geometry.computeBoundingBox();
                            const center = new THREE.Vector3();
                            geometry.boundingBox.getCenter(center);
                            geometry.translate(-center.x, -center.y, -center.z);
                            
                            // Compute normals for proper lighting
                            if (!geometry.attributes.normal) {
                                geometry.computeVertexNormals();
                            }
                            
                            // Create material
                            const material = new THREE.MeshPhongMaterial({
                                color: 0x8B4513,
                                shininess: 30,
                                side: THREE.DoubleSide
                            });
                            
                            // Check if PLY has vertex colors
                            if (geometry.attributes.color) {
                                material.vertexColors = true;
                            }
                            
                            // Create mesh
                            bear = new THREE.Mesh(geometry, material);
                            
                            // Scale appropriately for VR
                            const box = new THREE.Box3().setFromObject(bear);
                            const size = box.getSize(new THREE.Vector3());
                            const maxDimension = Math.max(size.x, size.y, size.z);
                            const targetSize = 2; // 2 meters tall in VR
                            const scale = targetSize / maxDimension;
                            
                            bear.scale.setScalar(scale);
                            bear.position.y = 0; // Place on ground
                            bear.castShadow = true;
                            bear.receiveShadow = true;
                            
                            scene.add(bear);
                            
                            console.log(`Bear added to scene. Vertices: ${geometry.attributes.position.count}, Scale: ${scale}`);
                            resolve();
                            
                        } catch (error) {
                            reject(error);
                        }
                    },
                    (progress) => {
                        const percent = Math.round((progress.loaded / progress.total) * 100);
                        updateStatus(`Loading bear... ${percent}%`);
                    },
                    (error) => {
                        console.error('PLY loading error:', error);
                        reject(error);
                    }
                );
            });
        }
        
        async function checkVRSupport() {
            if (navigator.xr) {
                try {
                    vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
                    if (vrSupported) {
                        updateStatus('‚úÖ VR Ready! Use VR button below');
                    } else {
                        updateStatus('‚ùå VR not supported on this device');
                    }
                } catch (error) {
                    updateStatus('‚ö†Ô∏è VR check failed: ' + error.message);
                }
            } else {
                updateStatus('‚ùå WebXR not available');
            }
        }
        
        function animate() {
            // Add some gentle animation to the bear
            if (bear) {
                const time = Date.now() * 0.001;
                bear.rotation.y = Math.sin(time * 0.5) * 0.1;
            }
            
            renderer.render(scene, camera);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Initialize everything
        init();
    </script>
</body>
</html>